<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miku Writer (Embed)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary: #39c5bb;
            --primary-light: #6be3db;
            --primary-hover: #2daaa0;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.8);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        body { 
            margin: 0; 
            padding: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
            /* 保持 Miku 氛围，但考虑到是 iframe，可以用透明或非常淡的背景，这里保留渐变让它看起来像个独立的卡片区域 */
            background: rgba(255, 255, 255, 0.85);
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* 防止 iframe 出现双滚动条 */
        }

        /* --- 主容器 --- */
        .main-container { 
            flex: 1; 
            display: flex; 
            padding: 100px 20px 20px 20px; /* 顶部留空给导航栏 */
            gap: 20px; 
            overflow: hidden; 
        }
        
        /* 发布按钮 - 特殊颜色 */
        .publish-tool { 
            color: var(--primary) !important; 
        }
        .publish-tool:hover { 
            background: var(--primary) !important; 
            color: white !important; 
        }
        .publish-tool:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 通用卡片样式 */
        .pane {
            border-radius: 16px; 
            box-shadow: var(--shadow); 
            border: var(--glass-border);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 1. 预览区域 
           Order: 1 
        */
        .preview-pane { 
            flex: 1; 
            background: rgba(255, 255, 255, 0.92); 
            padding: 40px; 
            overflow-y: auto; 
            order: 1;
        }

        /* 2. 编辑器区域 
           Order: 2
        */
        .editor-pane { 
            flex: 1; 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(5px);
            order: 2; 
        }
        
        /* --- 专注模式逻辑 (隐藏预览) --- */
        .preview-hidden .preview-pane {
            display: none;
            flex: 0;
        }
        
        /* 隐藏预览时，编辑器居中 */
        .preview-hidden .editor-pane {
            flex: initial;
            width: 850px; /* 类似 A4 纸宽度 */
            max-width: 100%;
            margin: 0 auto; /* 居中 */
        }

        /* --- 编辑器内部布局 --- */
        .meta-inputs { padding: 15px 20px 5px; display: flex; flex-direction: column; gap: 8px; }
        .input-group input { 
            width: 100%; border: none; outline: none; background: transparent;
            font-size: 1rem; padding: 8px 0; border-bottom: 2px solid rgba(0,0,0,0.05); transition: 0.3s; 
        }
        .input-group input:focus { border-bottom-color: var(--primary); }
        #title { font-size: 1.4rem; font-weight: 700; color: #333; }
        
        /* 工具栏 */
        .toolbar { 
            padding: 8px 15px; 
            background: rgba(255,255,255,0.4); 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; 
            gap: 4px; 
            align-items: center;
            flex-wrap: nowrap; /* 不换行 */
        }
        .tool-btn { 
            width: 32px; height: 32px; border: none; background: transparent; border-radius: 6px; 
            color: #555; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .tool-btn:hover { background: #fff; color: var(--primary); transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .toolbar-right { margin-left: auto; display: flex; gap: 6px; align-items: center; }

        .editor-wrapper { flex: 1; position: relative; }
        textarea { 
            width: 100%; height: 100%; border: none; resize: none; outline: none; 
            padding: 20px; 
            font-family: 'Menlo', 'Monaco', monospace; font-size: 15px; line-height: 1.6;
            background: transparent; color: #333;
        }
        textarea::-webkit-scrollbar { width: 6px; }
        textarea::-webkit-scrollbar-thumb { background: #ddd; border-radius: 3px; }

        /* Markdown 样式 */
        .markdown-body { background: transparent !important; }
        .markdown-body a { color: var(--primary); }

        @media (max-width: 768px) {
            .main-container { flex-direction: column-reverse; /* 手机上编辑在下，预览在上? 或者直接隐藏预览 */ }
            .preview-pane { display: none; } 
            .editor-pane { order: 1; } /* 手机上强制编辑器优先 */
        }
    </style>
</head>
<body>

    <script>
        if (!localStorage.getItem('auth_token')) {
            alert('请先登录喵~(T_T)');
            window.location.href = '../main.html';
        }
    </script>

    <div class="main-container" id="mainContainer">
        
        <div class="pane preview-pane markdown-body" id="preview">
            <div style="color:#aaa; text-align:center; margin-top:40px; opacity: 0.6;">
                <i class="fa-solid fa-wand-magic-sparkles" style="font-size: 2rem; margin-bottom: 10px; color: var(--primary-light);"></i>
                <p>左侧实时预览区域...</p>
            </div>
        </div>

        <div class="pane editor-pane">
            <div class="meta-inputs">
                <div class="input-group">
                    <input type="text" id="title" placeholder="文章标题..." autocomplete="off">
                </div>
                <div class="input-group">
                    <input type="text" id="summary" placeholder="简短摘要..." autocomplete="off">
                </div>
            </div>

            <div class="toolbar">
                <button class="tool-btn" onclick="insertMD('**', '**')" title="加粗"><i class="fa-solid fa-bold"></i></button>
                <button class="tool-btn" onclick="insertMD('*', '*')" title="斜体"><i class="fa-solid fa-italic"></i></button>
                <button class="tool-btn" onclick="insertMD('## ', '')" title="标题"><i class="fa-solid fa-heading"></i></button>
                <button class="tool-btn" onclick="insertMD('> ', '')" title="引用"><i class="fa-solid fa-quote-left"></i></button>
                <button class="tool-btn" onclick="insertMD('- ', '')" title="列表"><i class="fa-solid fa-list-ul"></i></button>
                <button class="tool-btn" onclick="insertMD('[', '](url)')" title="链接"><i class="fa-solid fa-link"></i></button>
                <button class="tool-btn" onclick="insertMD('![alt](', ')')" title="图片"><i class="fa-regular fa-image"></i></button>
                <button class="tool-btn" onclick="insertMD('```\n', '\n```')" title="代码"><i class="fa-solid fa-code"></i></button>

                <div class="toolbar-right">
                    <button class="tool-btn" onclick="togglePreview()" id="eyeBtn" title="切换预览">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                    <button class="tool-btn publish-tool" onclick="publish()" id="publishBtn" title="发布文章">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <div class="editor-wrapper">
                <textarea id="content" placeholder="在此处开始创作... (右侧编写，左侧预览)"></textarea>
            </div>
        </div>

    </div>

    <script>
        const API_URL = "http://localhost:8080/admin/posts";
        const editor = document.getElementById('content');
        const preview = document.getElementById('preview');
        const container = document.getElementById('mainContainer');
        const eyeBtn = document.getElementById('eyeBtn');
        const eyeIcon = eyeBtn.querySelector('i');

        // --- 切换预览逻辑 ---
        let isPreviewOn = true;

        function togglePreview() {
            isPreviewOn = !isPreviewOn;
            
            if (isPreviewOn) {
                container.classList.remove('preview-hidden');
                eyeIcon.className = 'fa-solid fa-eye';
                eyeBtn.classList.remove('active');
                // 刷新渲染
                const val = editor.value.trim();
                preview.innerHTML = val ? marked.parse(val) : getDefaultPreview();
            } else {
                container.classList.add('preview-hidden');
                eyeIcon.className = 'fa-solid fa-eye-slash'; 
                eyeBtn.classList.add('active'); 
            }
        }

        function getDefaultPreview() {
            return `<div style="color:#aaa; text-align:center; margin-top:40px; opacity: 0.6;">
                <i class="fa-solid fa-wand-magic-sparkles" style="font-size: 2rem; margin-bottom: 10px; color: var(--primary-light);"></i>
                <p>左侧实时预览区域...</p>
            </div>`;
        }

        // --- 实时渲染 ---
        editor.addEventListener('input', () => {
            if (isPreviewOn) {
                const val = editor.value.trim();
                preview.innerHTML = val ? marked.parse(val) : getDefaultPreview();
            }
        });

        // --- 插入 Markdown ---
        function insertMD(prefix, suffix) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selection = text.substring(start, end);
            const newText = text.substring(0, start) + prefix + selection + suffix + text.substring(end);
            
            editor.value = newText;
            editor.focus();
            editor.setSelectionRange(start + prefix.length, end + prefix.length);
            editor.dispatchEvent(new Event('input'));
        }

        // --- 发布 ---
        async function publish() {
            const btn = document.getElementById('publishBtn');
            const token = localStorage.getItem('auth_token');
            
            const data = {
                title: document.getElementById('title').value,
                summary: document.getElementById('summary').value,
                content: editor.value
            };

            if(!data.title || !data.content) {
                alert('别忘了写标题和正文哦！');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 发送中...';

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': token },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('发布成功喵！');
                    // 清空或跳转
                    document.getElementById('title').value = '';
                    document.getElementById('summary').value = '';
                    editor.value = '';
                    preview.innerHTML = getDefaultPreview();
                } else if (res.status === 401) {
                    alert('登录失效喵~(T_T)');
                    logout();
                } else {
                    alert('发布失败喵~(T_T)');
                }
            } catch (err) {
                alert('网络错误喵~(T_T)');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> 发布文章';
            }
        }

        function logout() {
            if(confirm('确定要退出吗？(T_T)')) {
                localStorage.clear();
                window.location.href = '../main.html'; 
            }
        }
    </script>
</body>
</html>