# 深浅色模式切换说明

## 概述

通过 `body.dark-mode` 类控制页面主题，使用 `localStorage` 持久化存储用户偏好，支持主框架与 iframe 子页面的主题同步。

## 实现原理

### 1. CSS 类控制

所有深色模式样式都通过 `body.dark-mode` 前缀定义：

```css
/* 浅色模式（默认） */
.article-card {
    background: #fff;
    color: #333;
}

/* 深色模式 */
body.dark-mode .article-card {
    background: #2a2a2a;
    color: #f0f0f0;
}
```

### 2. localStorage 持久化

```javascript
// 保存主题偏好
localStorage.setItem('theme', 'dark');  // 或 'light'

// 读取主题偏好
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') {
    document.body.classList.add('dark-mode');
}
```

### 3. 主题切换流程

```
用户点击切换按钮
       ↓
切换 body.dark-mode 类
       ↓
保存到 localStorage
       ↓
同步到 iframe 子页面
```

## 核心代码

### navbar.js - 主题逻辑

```javascript
// 1. 页面加载时立即应用主题（所有页面，包括iframe中的）
document.addEventListener('DOMContentLoaded', function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
    }
    
    // 如果在iframe中，到此结束
    if (window.self !== window.top) {
        return;
    }
    
    // 2. 主框架页面：创建导航栏和主题切换按钮
    // ...
});

// 3. 主题切换函数
const applyTheme = (isDark) => {
    // 切换当前页面
    document.body.classList.toggle('dark-mode', isDark);
    
    // 更新按钮文字
    themeText.textContent = isDark ? '深色模式' : '浅色模式';
    
    // 同步到iframe
    const iframe = document.getElementById('contentFrame');
    if (iframe?.contentDocument?.body) {
        iframe.contentDocument.body.classList.toggle('dark-mode', isDark);
    }
};

// 4. 点击事件
themeToggle.addEventListener('click', function() {
    const isDark = !document.body.classList.contains('dark-mode');
    applyTheme(isDark);
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
});
```

### main-frame.js - iframe同步

```javascript
// iframe加载新页面时同步主题
iframe.addEventListener('load', () => {
    const isDark = document.body.classList.contains('dark-mode');
    if (isDark) {
        iframe.contentDocument.body.classList.add('dark-mode');
    }
});
```

## 涉及的CSS文件

各CSS文件中的深色模式样式：

| 文件 | 内容 |
|------|------|
| `navbar.css` | 侧边栏、菜单按钮、主内容区背景 |
| `blog-layout/dark-mode.css` | 文章卡片、作者卡片、弹窗 |
| `gallery/dark-mode.css` | 画廊卡片、信息栏、横幅 |

### 示例：navbar.css

```css
/* 深色模式 - 侧边栏 */
body.dark-mode .sidebar {
    background: rgba(30, 30, 30, 0.95);
}

body.dark-mode .sidebar-title,
body.dark-mode .nav-link {
    color: #e0e0e0;
}

/* 深色模式 - 主内容区 */
body.dark-mode .main-content {
    background: #1a1a1a;
}
```

### 示例：blog-layout/dark-mode.css

```css
body.dark-mode .article-card {
    background: #2a2a2a;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
}

body.dark-mode .article-title {
    color: #f0f0f0;
}

body.dark-mode .author-card {
    background: #2a2a2a;
}
```

## 数据流图

```
┌─────────────────────────────────────────────────────┐
│                    main.html                        │
│  ┌─────────────┐    ┌─────────────────────────┐    │
│  │  侧边栏     │    │      iframe             │    │
│  │             │    │  ┌─────────────────┐    │    │
│  │ [深色模式]  │───→│  │   子页面        │    │    │
│  │   按钮      │    │  │ body.dark-mode  │    │    │
│  └─────────────┘    │  └─────────────────┘    │    │
│         │           └─────────────────────────┘    │
│         ↓                                          │
│  localStorage.setItem('theme', 'dark')             │
└─────────────────────────────────────────────────────┘
         ↓
┌─────────────────────────────────────────────────────┐
│              页面刷新 / 新页面加载                   │
│                        ↓                            │
│         localStorage.getItem('theme')               │
│                        ↓                            │
│         document.body.classList.add('dark-mode')    │
└─────────────────────────────────────────────────────┘
```

## 添加新页面的深色模式

1. **引入navbar.js**（自动读取主题偏好）

```html
<script src="../js/navbar.js"></script>
```

2. **在CSS中添加深色模式样式**

```css
/* 你的组件默认样式 */
.my-component {
    background: #fff;
    color: #333;
}

/* 深色模式 */
body.dark-mode .my-component {
    background: #2a2a2a;
    color: #e0e0e0;
}
```

## 注意事项

1. **localStorage 跨域** - 主框架和iframe必须同源才能共享localStorage
2. **CSS优先级** - 深色模式样式使用 `body.dark-mode` 前缀确保优先级
3. **初始闪烁** - 主题在DOM加载后应用，可能有短暂闪烁（可用CSS预处理优化）

