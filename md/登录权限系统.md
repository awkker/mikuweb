# Mikuweb 登录权限系统

> 简单但完整的前后端鉴权方案

## 系统概述

Mikuweb 使用 **单管理员密码制** 实现权限控制：
- 普通访客：可以浏览内容、发表评论
- 管理员：可以发布/编辑/删除文章，删除评论

---

## 技术栈

| 层级 | 技术 |
|------|------|
| 前端 | 原生 JS + LocalStorage |
| 后端 | Go + Gin 框架 |
| 数据库 | SQLite + GORM |
| 通信 | RESTful API + JSON |

---

## 文件结构

```
mikuweb/
├── comments/
│   └── main.go              # 后端服务（Go）
├── static/
│   ├── js/
│   │   └── user.js          # 前端登录逻辑
│   ├── css/
│   │   └── login.css        # 登录弹窗样式
│   └── html/
│       └── admin/
│           └── write.html   # 管理员写作页面
└── data.db                  # SQLite 数据库
```

---

## 后端实现 (Go + Gin)

### 1. 配置常量

```go
// main.go
const ADMIN_PASSWORD = "123456"    // 管理员密码
const ADMIN_NICKNAME = "awkker"    // 管理员昵称
const ADMIN_AVATAR = "../images/picture/author/xunyi.png"
```

### 2. 登录接口

```go
// POST /login - 管理员登录验证
r.POST("/login", func(c *gin.Context) {
    var input struct {
        Password string `json:"password"`
    }
    c.ShouldBindJSON(&input)

    if input.Password == ADMIN_PASSWORD {
        // 登录成功，返回 Token 和用户信息
        c.JSON(200, gin.H{
            "token":    ADMIN_PASSWORD,  // 简化处理，实际应用 JWT
            "nickname": ADMIN_NICKNAME,
            "avatar":   ADMIN_AVATAR,
        })
    } else {
        c.JSON(401, gin.H{"error": "密码错误喵！(>_<)"})
    }
})
```

### 3. 权限中间件

```go
// AuthMiddleware 验证管理员权限
func AuthMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        token := c.GetHeader("Authorization")
        if token != ADMIN_PASSWORD {
            c.AbortWithStatusJSON(401, gin.H{
                "error": "权限不足喵！请输入管理员密码！"
            })
            return
        }
        c.Next()  // 验证通过，继续处理请求
    }
}
```

### 4. 接口权限划分

```go
// ===== 公开接口 (任何人可访问) =====
r.GET("/comments", ...)     // 获取评论列表
r.POST("/comments", ...)    // 发表评论
r.GET("/posts", ...)        // 获取文章列表
r.GET("/posts/:id", ...)    // 获取文章详情
r.POST("/login", ...)       // 登录

// ===== 管理员接口 (需要密码) =====
admin := r.Group("/admin")
admin.Use(AuthMiddleware())  // 应用权限中间件
{
    admin.POST("/posts", ...)       // 发布文章
    admin.PUT("/posts/:id", ...)    // 编辑文章
    admin.DELETE("/posts/:id", ...) // 删除文章
    admin.DELETE("/comments/:id", ...) // 删除评论
}
```

---

## 前端实现 (JavaScript)

### 1. 登录弹窗模块

```javascript
// user.js - LoginModal 对象
const LoginModal = {
    modal: null,
    input: null,

    // 显示弹窗
    show() {
        this.modal.style.display = 'flex';
        setTimeout(() => {
            this.modal.classList.add('active');
            this.input.focus();
        }, 10);
    },

    // 隐藏弹窗
    hide() {
        this.modal.classList.remove('active');
        setTimeout(() => {
            this.modal.style.display = 'none';
        }, 300);
    },

    // 提交登录
    async submit() {
        const password = this.input.value;
        
        const response = await fetch('http://localhost:8080/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
        });

        if (response.ok) {
            const data = await response.json();
            // 登录成功，保存到 LocalStorage
            localStorage.setItem('auth_token', data.token);
            localStorage.setItem('user_nickname', data.nickname);
            localStorage.setItem('user_avatar', data.avatar);
            
            this.hide();
            location.reload();
        } else {
            this.shake();  // 密码错误，抖动提示
        }
    },

    // 错误抖动动画
    shake() {
        const box = document.querySelector('.login-box');
        box.classList.add('shake');
        setTimeout(() => box.classList.remove('shake'), 500);
    }
};
```

### 2. 用户状态管理

```javascript
// user.js - UserModule 模块
const UserModule = (function() {
    
    // 检查是否已登录
    function isLoggedIn() {
        return localStorage.getItem('auth_token') !== null;
    }

    // 初始化用户界面
    function init() {
        const avatarImg = document.getElementById('user-avatar');
        const nameEl = document.getElementById('menu-username');
        
        if (isLoggedIn()) {
            // 已登录：显示管理员头像和昵称
            avatarImg.src = '../images/picture/author/xunyi.png';
            nameEl.textContent = localStorage.getItem('user_nickname');
        } else {
            // 未登录：显示默认头像
            avatarImg.src = '../images/picture/logo/user.png';
        }
    }

    // 点击头像的处理
    function handleUserClick() {
        if (isLoggedIn()) {
            // 已登录：显示用户菜单
            document.getElementById('user-menu').classList.toggle('show');
        } else {
            // 未登录：显示登录弹窗
            LoginModal.show();
        }
    }

    // 退出登录
    function logout() {
        if (confirm("确定要离开吗？")) {
            localStorage.clear();
            location.reload();
        }
    }

    return { init, handleUserClick, logout };
})();

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', UserModule.init);
```

### 3. 管理员请求示例

```javascript
// 发布文章（需要带上 Token）
async function publishPost(postData) {
    const token = localStorage.getItem('auth_token');
    
    const response = await fetch('http://localhost:8080/admin/posts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token  // 关键：带上验证头
        },
        body: JSON.stringify(postData)
    });
    
    if (response.status === 401) {
        alert('登录已过期，请重新登录！');
        localStorage.clear();
        location.reload();
    }
    
    return response.json();
}
```

---

## 登录弹窗样式 (CSS)

```css
/* login.css */

/* 全屏蒙层 */
.login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(8px);
    z-index: 2000;
    display: none;
    justify-content: center;
    align-items: center;
}

/* 登录框 - Q弹动画 */
.login-box {
    width: 320px;
    padding: 30px;
    background: rgba(255, 255, 255, 0.85);
    border-radius: 24px;
    transform: scale(0.8);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.login-overlay.active .login-box {
    transform: scale(1);
}

/* 错误抖动 */
@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}
```

---

## 数据流程图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户点击登录                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  前端: LoginModal.show() 显示登录弹窗                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ 输入密码，点击登录
┌─────────────────────────────────────────────────────────────┐
│  前端: fetch('POST /login', { password })                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  后端: 验证密码                                              │
│  - 正确: 返回 { token, nickname, avatar }                   │
│  - 错误: 返回 401 { error: "密码错误" }                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ 登录成功
┌─────────────────────────────────────────────────────────────┐
│  前端: localStorage.setItem('auth_token', token)            │
│        localStorage.setItem('user_nickname', nickname)      │
│        刷新页面                                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ 后续管理员操作
┌─────────────────────────────────────────────────────────────┐
│  前端: fetch('POST /admin/posts', {                         │
│          headers: { Authorization: token }                  │
│        })                                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  后端: AuthMiddleware() 验证 Header 中的 Token              │
│  - 验证通过: 执行操作                                        │
│  - 验证失败: 返回 401 "权限不足"                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 安全注意事项

> ⚠️ 当前实现是**简化版本**，适合个人项目学习使用

### 生产环境建议改进

1. **密码加密**：使用 bcrypt 对密码进行哈希存储
2. **JWT Token**：使用 JWT 替代明文密码作为 Token
3. **Token 过期**：设置 Token 有效期，定期刷新
4. **HTTPS**：使用 HTTPS 加密传输
5. **防暴力破解**：限制登录尝试次数

---

## 总结

这套登录权限系统实现了：

1. **前端**：登录弹窗 + LocalStorage 状态管理
2. **后端**：Gin 中间件实现接口权限控制
3. **通信**：通过 Authorization Header 传递 Token
4. **体验**：Q弹动画 + 错误抖动 + 自动聚焦

虽然简单，但涵盖了完整的鉴权流程，可以作为更复杂系统的基础。
