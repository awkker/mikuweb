<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Go + Web Components Demo</title>
</head>
<body>

    <my-comments></my-comments>

    <script>
        // è‡ªå®šä¹‰ç»„ä»¶ç±»
        class MyComments extends HTMLElement {
            constructor() {
                super();
                // å¼€å¯ Shadow DOMï¼Œè®©æ ·å¼ä¸å¤–éƒ¨éš”ç¦»ï¼Œäº’ä¸å½±å“
                this.attachShadow({ mode: 'open' });
                this.apiUrl = 'http://localhost:8080/comments'; 
            }

            connectedCallback() {
                this.render();
                this.fetchComments(); // ç»„ä»¶åŠ è½½æ—¶æ‹‰å–æ•°æ®
            }

            render() {
                this.shadowRoot.innerHTML = `
                <style>
                    :host { display: block; font-family: sans-serif; }
                    .container { 
                        max-width: 500px; margin: 20px auto; 
                        border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
                    }
                    h3 { margin-top: 0; color: #333; }
                    ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
                    li { border-bottom: 1px solid #f0f0f0; padding: 10px 0; }
                    .content { font-size: 16px; color: #444; }
                    .time { font-size: 12px; color: #999; margin-top: 4px; }
                    .input-group { display: flex; gap: 10px; margin-top: 20px; }
                    input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
                    button { 
                        padding: 8px 16px; background: #007bff; color: white; 
                        border: none; border-radius: 4px; cursor: pointer; 
                    }
                    button:hover { background: #0056b3; }
                </style>

                <div class="container">
                    <h3>ğŸ’¬ è¯„è®ºåŒº</h3>
                    <ul id="list">åŠ è½½ä¸­...</ul>
                    <div class="input-group">
                        <input type="text" id="input" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." />
                        <button id="btn">å‘é€</button>
                    </div>
                </div>
                `;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                this.shadowRoot.getElementById('btn').onclick = () => this.postComment();
            }

            // è·å–è¯„è®º (GET)
            async fetchComments() {
                try {
                    const res = await fetch(this.apiUrl);
                    const data = await res.json();
                    
                    const list = this.shadowRoot.getElementById('list');
                    if (data.length === 0) {
                        list.innerHTML = '<li style="text-align:center;color:#999">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘ï¼</li>';
                        return;
                    }

                    list.innerHTML = data.map(c => `
                        <li>
                            <div class="content">${this.escapeHtml(c.content)}</div>
                            <div class="time">${new Date(c.created_at).toLocaleString()}</div>
                        </li>
                    `).join('');
                } catch (err) {
                    console.error("API Error:", err);
                    this.shadowRoot.getElementById('list').innerHTML = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚';
                }
            }

            // æäº¤è¯„è®º (POST)
            async postComment() {
                const input = this.shadowRoot.getElementById('input');
                const content = input.value.trim();
                if (!content) return;

                try {
                    await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: content })
                    });
                    
                    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    this.fetchComments(); // åˆ·æ–°åˆ—è¡¨
                } catch (err) {
                    alert("å‘é€å¤±è´¥ï¼");
                }
            }

            // ç®€å•çš„ XSS é˜²å¾¡
            escapeHtml(text) {
                return text
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }

        // æ³¨å†Œç»„ä»¶
        customElements.define('my-comments', MyComments);
    </script>
</body>
</html>